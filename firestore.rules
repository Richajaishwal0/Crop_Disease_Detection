
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isUser(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function userRole() {
      return request.auth != null
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function isAdmin() {
      return userRole() == 'admin';
    }

    function isModerator() {
      return userRole() in ['admin', 'moderator'];
    }

    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid &&
                    (request.resource.data.role in ['user', 'farmer']);
      allow update: if (isUser(userId) &&
                      (request.resource.data.diff(resource.data).changedKeys().hasOnly(['displayName', 'username', 'photoURL', 'region']))) ||
                      (isAdmin() && request.resource.data.diff(resource.data).changedKeys().hasOnly(['role', 'isVerified']));
      allow delete: if isAdmin() || isUser(userId);

      match /cart/{productId} {
        allow read, list, write, delete: if isUser(userId);
      }
    }

    // Expert dashboard collections
    match /diagnosisSubmissions/{submissionId} {
      allow read, list, create, update: if request.auth != null;
    }

    match /notifications/{notificationId} {
      allow read, list, create, update: if request.auth != null;
    }

    match /messages/{messageId} {
      allow read, list, create, update: if request.auth != null;
    }

    match /communities/{communityId} {
      allow read, list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.creatorId == request.auth.uid;
      allow update: if request.auth != null && (
        (isUser(resource.data.creatorId) && request.resource.data.diff(resource.data).changedKeys().hasOnly(['name', 'description', 'iconUrl', 'bannerUrl', 'type', 'isMature'])) ||
        (request.resource.data.diff(resource.data).changedKeys().hasOnly(['postCount']))
      );
      allow delete: if request.auth != null && (isUser(resource.data.creatorId) || isModerator());
    }

    match /posts/{postId} {
      allow read, list: if true;
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow update: if request.auth != null && (
        (isUser(resource.data.uid) && request.resource.data.diff(resource.data).changedKeys().hasOnly(['title', 'text', 'imageUrl'])) ||
        (request.resource.data.diff(resource.data).changedKeys().hasOnly(['upvotes', 'downvotes', 'commentCount', 'pinnedCommentId']))
      );
      allow delete: if request.auth != null && (isUser(resource.data.uid) || isModerator());

      match /comments/{commentId} {
        allow read, list: if request.auth != null;
        allow create: if request.auth != null
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.keys().hasOnly([
                      'id',
                      'uid',
                      'author',
                      'authorPhotoURL',
                      'authorRole',
                      'text',
                      'createdAt',
                      'parentId',
                      'replyCount',
                      'upvotes',
                      'downvotes'
                    ]);
        allow update: if request.auth != null && (
          (isUser(resource.data.uid) && request.resource.data.diff(resource.data).changedKeys().hasOnly(['text', 'imageUrl', 'updatedAt'])) ||
          (request.resource.data.diff(resource.data).changedKeys().hasOnly(['upvotes', 'downvotes', 'replyCount']))
        );
        allow delete: if request.auth != null && (isUser(resource.data.uid) || isModerator());
      }
    }

    match /products/{productId} {
      function userIsVerifiedSeller(userId) {
        let user = get(/databases/$(database)/documents/users/$(userId));
        return user.exists() && user.data.isVerified == true;
      }

      allow read, list: if true;
      allow create: if request.auth != null && isUser(request.resource.data.uid) && userIsVerifiedSeller(request.auth.uid);
      allow update, delete: if request.auth != null && isUser(resource.data.uid) && userIsVerifiedSeller(request.auth.uid);
    }

    match /marketplacePosts/{postId} {
      allow read, list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      allow update: if request.auth != null && (
        (isUser(resource.data.uid) && request.resource.data.diff(resource.data).changedKeys().hasOnly(['itemName', 'description', 'price', 'quantity', 'condition', 'imageUrl'])) ||
        (request.resource.data.diff(resource.data).changedKeys().hasOnly(['upvotes', 'downvotes', 'commentCount']))
      );
      allow delete: if request.auth != null && (isUser(resource.data.uid) || isModerator());

      match /comments/{commentId} {
        allow read, list: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
        allow update: if request.auth != null && (
          (isUser(resource.data.uid) && request.resource.data.diff(resource.data).changedKeys().hasOnly(['text', 'imageUrl'])) ||
          (request.resource.data.diff(resource.data).changedKeys().hasOnly(['upvotes', 'downvotes']))
        );
        allow delete: if request.auth != null && (isUser(resource.data.uid) || isModerator());
      }
    }
  }
}
